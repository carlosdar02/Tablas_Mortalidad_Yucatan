sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
knitr::kable(lt_output[,-1], caption = "Tabla de mortalidad 2010, 2019, 2021")
```{r, WARNING = FALSE, ECHO = FALSE }
lt_output <- data.table()
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
knitr::kable(lt_output[,-1], caption = "Tabla de mortalidad 2010, 2019, 2021")
rm(list = ls())  # Limpiar entorno
gc()             # Liberar memoria
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
#Carga de paquetes y funciones ----
library(MortalityLaws)
library(data.table)
library(dplyr)
library(tidyr)
library(kableExtra)
library(readxl)
library(reshape2)
library(lubridate)
library(ggplot2)
library(knitr)
source("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/script/funciones.R")
lt_abr <- function(x, mx, sex="f", IMR=NA){
m <- length(x)
n <- c(diff(x), NA)
ax <- n/2
# Pag. 4 notas de clase - cuadro
## Coale y Demeny edades 0 a 1
if(sex=="m"){
if(mx[1]>=0.107){ ax[1] <- 0.330 }else{
ax[1] <- 0.045+2.684*mx[1]
}
} else if(sex=="f"){
if(mx[1]>=0.107){ ax[1] <- 0.350 }else{
ax[1] <- 0.053+2.800*mx[1]
}
}
## Coale y Demeny edades 1 a 4
if(sex=="m"){
if(mx[1]>=0.107){ ax[2] <- 1.352 }else{
ax[2] <- 1.651-2.816*mx[1]
}
} else if(sex=="f"){
if(mx[1]>=0.107){ ax[2] <- 1.361 }else{
ax[2] <- 1.522-1.518*mx[1]
}
}
# Probabilidad de muerte
qx <- (n*mx)/(1+(n-ax)*mx)
qx[m] <- 1
# Proba de sobrevivir
px <- 1-qx
# l_x
lx <- 100000 * cumprod(c(1,px[-m]))
# Defunciones
dx <- c(-diff(lx), lx[m])
# Años persona vividos
Lx <- n* c(lx[-1], 0) + ax*dx
Lx[m] <- lx[m]/mx[m]
# Años persona vividos acumulados
Tx <- rev(cumsum(rev(Lx)))
# Esperanza de vida
ex <- Tx/lx
return(data.table(x, n, mx, ax, qx, px, lx, dx, Lx, Tx, ex))
}
# Uso la función lt_abr
# lt_abr(x, mx)
# 3. Crecimiento exponencial ----
expo <- function(N_0, N_T, t_0, t_T, t){
dt <- decimal_date(as.Date(t_T)) - decimal_date(as.Date(t_0))
r <- log(N_T/N_0)/dt
h <- t - decimal_date(as.Date(t_0))
N_h <- N_0 * exp(r*h)
return(N_h)
}
# Descomposición, formula de Arriaga ----
arriaga_decomp <- function(data, y1, y2, sex_filter){
# Fórmula para los grupos de edad
suppressWarnings({
dt_calc[, delta := (lx1 / l0_1) * ( (Lx2/lx2) - (Lx1/lx1) ) +
(Tx2_next / l0_1) * ( (lx1/lx2) - (lx1_next/lx2_next) ) ]
# Último grupo de edad
n <- nrow(dt_calc)
dt_calc[n, delta := (lx1 / l0_1) * ( (Tx2/lx2) - (Tx1/lx1) )]})
}
#Carga de tabla de datos ----
censos_pro <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/censos_pro.csv")
# Cálculo de años persona vividos (población a mitad de año) 2010----
N <- expo(censos_pro[year==2010] %>% .$pop,
censos_pro[year==2020] %>% .$pop,
t_0 = "2010-06-25", t_T = "2020-03-15", t = 2010.5)
apv2010 <- censos_pro[year==2010, .(age, sex, N)]
apv2010[ , year:= 2010]
# Cálculo de años persona vividos (población a mitad de año) 2019 ----
N <- expo(censos_pro[year==2010] %>% .$pop,
censos_pro[year==2020] %>% .$pop,
t_0 = "2010-06-25", t_T = "2020-03-15", t = 2019.5)
apv2019 <- censos_pro[year==2020, .(age, sex, N)]
apv2019[ , year:= 2019]
# Cálculo de años persona vividos (población a mitad de año) 2021----
N <- expo(censos_pro[year==2010] %>% .$pop,
censos_pro[year==2020] %>% .$pop,
t_0 = "2010-06-25", t_T = "2020-03-15", t = 2021.5)
apv2021 <- censos_pro[year==2020, .(age, sex, N)]
apv2021[ , year:= 2021]
## Carga de tablas de datos ----
def_pro <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/def_pro.csv") %>%
.[year %in% c(2009, 2010, 2011, 2018, 2019, 2021)]
## calculo del promedio para el ano de referencia
def_pro[ , year_new := ifelse( year %in% 2009:2011,
2010,
ifelse( year %in% 2018:2019,
2019,
year ) ) ]
# datos preparados de defunciones
def <-
def_pro[ ,
.( deaths = mean( deaths ) ),
.( year = year_new, sex, age ) ]
# Carga de tablas de datos ----
library(data.table)   # <-- ESTA FALTA
library(dplyr)
library(kableExtra)
## Carga de tablas de datos ----
def <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/def.csv")
apv <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/apv.csv")
# Unión de tablas de Años Persona Vividos y Defunciones ----
lt_input <- setDT(left_join(apv, def, by = c("year", "sex", "age")))
# Cálculo de mx ----
lt_input[ , mx := deaths/N]
lt_input[ , sex := if_else(sex=="male", "m", "f")]
# Tablas de mortalidad
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
mx = round( mx, 6 ),
qx = round( qx, 6 ),
ax = round( ax, 2 ),
lx = round( lx, 0 ),
dx = round( dx, 0 ),
Lx = round( Lx, 0 ),
Tx = round( Tx, 0 ),
ex = round( ex, 2 )) ]
)
}
}
## Esperanzas de vida al nacer ----
# 1. Tabla de Esperanza de Vida al Nacer (e0)
library(data.table)
library(dplyr)
library(kableExtra)
# Convertir a data.table si no lo es
lt_output[age == 0] %>%
as.data.table() %>%   # Convertir a data.table
dcast(year ~ sex, value.var = "ex") %>%
kbl(
caption = "Esperanza de vida al nacer ($e_0$)",
col.names = c("Año", "Mujeres", "Hombres"),
digits = 2,
align = "c",
booktabs = TRUE,
escape = FALSE
) %>%
kable_styling(
latex_options = c("striped", "hold_position"),
full_width = FALSE,
position = "center"
) %>%
add_header_above(c(" " = 1, "Sexo" = 2))
## Mortalidad infantil ----
lt_output[ age == 0 ] %>%
dcast( year ~ sex, value.var = 'qx' ) %>%
kbl(
caption = "Mortalidad Infantil ($q_0$)",
col.names = c("Año", "Mujeres", "Hombres"),
digits = 5, # Usamos 5 decimales porque qx es una probabilidad pequeña
align = "c",
booktabs = TRUE,
escape = FALSE
) %>%
kable_styling(
latex_options = c("striped", "hold_position"),
full_width = FALSE,
position = "center"
) %>%
add_header_above(c(" " = 1, "Sexo" = 2))
# Aplicar descomposición por sexo y períodos
descomposicion_resultados <- list()
# Período 2010-2019
for (sexo in c("m", "f")) {
lt_2010 <- lt_output[year == 2010 & sex == sexo]
lt_2019 <- lt_output[year == 2019 & sex == sexo]
descomp <- descomposicion_arriaga(lt_2010, lt_2019)
descomp$tabla_contribuciones[, `:=`(
sexo = sexo,
periodo = "2010-2019"
)]
descomposicion_resultados[[paste0("2010_2019_", sexo)]] <- descomp
}
# Período 2019-2021
for (sexo in c("m", "f")) {
lt_2019 <- lt_output[year == 2019 & sex == sexo]
lt_2021 <- lt_output[year == 2021 & sex == sexo]
descomp <- descomposicion_arriaga(lt_2019, lt_2021)
descomp$tabla_contribuciones[, `:=`(
sexo = sexo,
periodo = "2019-2021"
)]
descomposicion_resultados[[paste0("2019_2021_", sexo)]] <- descomp
}
# Consolidar resultados
tabla_descomposicion <- rbindlist(
lapply(descomposicion_resultados, function(x) x$tabla_contribuciones)
)
# Carga de datos ----
def_homicidios <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/def_pro_hom.csv")
def_totales <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/def_pro.csv")
apv <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/apv.csv")
lt_output <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/lt_yuc.csv")
# Verificar y corregir estructura de datos ----
cat("Estructura de lt_output:\n")
print(names(lt_output))
cat("\n")
# Si lt_output tiene columna 'x' en lugar de 'age', renombrar
if ("x" %in% names(lt_output) & !"age" %in% names(lt_output)) {
lt_output[, age := x]
lt_output[, x := NULL]
}
# Procesamiento para causa eliminada ----
## Filtrar años de interés para homicidios ----
def_homicidios <- def_homicidios[year %in% c(2009, 2010, 2011, 2018, 2019, 2021)]
## Crear años de referencia (igual que en el procesamiento original) ----
def_homicidios[, year_new := ifelse(year %in% 2009:2011, 2010,
ifelse(year %in% 2018:2019, 2019, 2021))]
## Promediar homicidios por año de referencia ----
homicidios_promedio <- def_homicidios[, .(deaths_homicidios = mean(deaths)),
by = .(year = year_new, sex, age)]
## Unir homicidios con defunciones totales ----
def_completa <- merge(def_totales, homicidios_promedio,
by = c("year", "sex", "age"),
all.x = TRUE)
## Si no hay datos de homicidios para alguna observación, asumir 0 ----
def_completa[is.na(deaths_homicidios), deaths_homicidios := 0]
## Calcular defunciones por otras causas (excluyendo homicidios) ----
def_completa[, deaths_otras := deaths - deaths_homicidios]
## Calcular proporción de homicidios ----
def_completa[, prop_homicidios := deaths_homicidios / deaths]
def_completa[is.infinite(prop_homicidios) | is.na(prop_homicidios), prop_homicidios := 0]
# Unir con población para calcular tasas ----
## Unir defunciones completas con población ----
lt_input_homicidios <- merge(apv, def_completa, by = c("year", "sex", "age"), all.x = TRUE)
## Calcular tasas de mortalidad ----
# mx totales (todas las causas)
lt_input_homicidios[, mx_todas_causas := deaths / N]
# mx sin homicidios
lt_input_homicidios[, mx_sin_homicidios := deaths_otras / N]
# Asegurar que no hay valores negativos
lt_input_homicidios[mx_sin_homicidios < 0, mx_sin_homicidios := 0]
# Convertir sexo a formato corto
lt_input_homicidios[, sex := ifelse(sex == "male", "m", "f")]
# Construcción de tablas de vida sin homicidios ----
lt_sin_homicidios <- data.table()
for (s in c('m', 'f')) {
for (y in c(2010, 2019, 2021)) {
cat("Procesando:", s, "-", y, "\n")
# Filtrar datos para el sexo y año
temp_dt <- lt_input_homicidios[sex == s & year == y]
# Construir tabla de vida sin homicidios
temp_lt <- lt_abr(
x = temp_dt$age,
mx = temp_dt$mx_sin_homicidios,
sex = s
)
# Convertir a data.table y agregar columnas
temp_lt <- as.data.table(temp_lt)
temp_lt[, year := y]
temp_lt[, sex := s]
temp_lt[, causa := "sin_homicidios"]
# Renombrar columna 'x' a 'age' para consistencia
if ("x" %in% names(temp_lt)) {
temp_lt[, age := x]
temp_lt[, x := NULL]
}
lt_sin_homicidios <- rbind(lt_sin_homicidios, temp_lt, fill = TRUE)
}
}
# Preparar datos para comparación ----
## Agregar identificador de causa a las tablas originales ----
lt_output[, causa := "todas_causas"]
## Verificar columnas disponibles ----
cat("Columnas en lt_output:", names(lt_output), "\n")
cat("Columnas en lt_sin_homicidios:", names(lt_sin_homicidios), "\n")
## Seleccionar columnas comunes para comparación ----
columnas_comunes <- intersect(names(lt_output), names(lt_sin_homicidios))
columnas_comunes <- columnas_comunes[columnas_comunes %in%
c("year", "sex", "age", "mx", "qx", "lx", "dx", "Lx", "Tx", "ex", "causa")]
cat("Columnas comunes para comparación:", columnas_comunes, "\n")
## Combinar tablas ----
lt_comparacion <- rbind(
lt_output[, ..columnas_comunes],
lt_sin_homicidios[, ..columnas_comunes],
fill = TRUE
)
# Análisis de resultados ----
## Esperanza de vida al nacer comparativa ----
e0_comparacion <- lt_comparacion[age == 0, .(year, sex, ex, causa)]
## Diferencia en esperanza de vida debido a homicidios ----
e0_todas <- e0_comparacion[causa == "todas_causas", .(year, sex, ex_todas = ex)]
e0_sin <- e0_comparacion[causa == "sin_homicidios", .(year, sex, ex_sin = ex)]
e0_dif <- merge(e0_todas, e0_sin, by = c("year", "sex"))
e0_dif[, dif_homicidios := ex_sin - ex_todas]  # Cambio aquí: ex_sin - ex_todas
cat("Diferencia en esperanza de vida debido a homicidios:\n")
print(e0_dif)
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
knitr::kable(lt_output[,-1], caption = "Tabla de mortalidad 2010, 2019, 2021")
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
knitr::kable(lt_output[,-1], caption = "Tabla de mortalidad 2010, 2019, 2021")
lt_output <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/lt_yuc.csv")
lt_output <- data.table()
for( s in c( 'm', 'f' ) ){
for( y in unique( lt_input$year ) ){
temp_dt <- lt_input[ sex == s & year == y ]
temp_lt <-
lt_abr(x = temp_dt$age,
mx = temp_dt$mx,
sex = s) %>%
setDT %>%
.[ , year := y ] %>%
.[ , sex := s ]
lt_output <-
rbind(
lt_output,
temp_lt[ , .( lt_desc = 'LT VR/Census, MEX',
year = y,
sex,
age = x,
"$m_x$" = round( mx, 6 ),
"$q_x$" = round( qx, 6 ),
"$a_x$" = round( ax, 2 ),
"$l_x$" = round( lx, 0 ),
"$d_x$" = round( dx, 0 ),
"$L_x$" = round( Lx, 0 ),
"$T_x$" = round( Tx, 0 ),
"$e_x$" = round( ex, 2 )) ]
)
}
}
knitr::kable(lt_output[,-1], caption = "Tabla de mortalidad 2010, 2019, 2021")
lt_output <- fread("C:/Users/Charlitos/OneDrive/Documentos/FAC CIENCIAS/Demo/Demo_Final_Proj/data/lt_yuc.csv")
tabla_resumen <- lt_output[age %in% c(0, 1, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)]
# Usar kable sin kableExtra para evitar posibles conflictos
knitr::kable(tabla_resumen[, .(Año = year,
Sexo = ifelse(sex == "m", "Hombre", "Mujer"),
Edad = age,
`m_x` = round(mx, 6),
`q_x` = round(qx, 6),
`e_x` = round(ex, 2))],
caption = "Tabla de Mortalidad Resumida - Yucatán",
align = "c",
booktabs = TRUE)
# Inicializa Git
git init
# Inicializa Git
git init
cd C:\Users\TuUsuario\Documents\TrabajoFinal_Demografia
